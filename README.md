# 加密货币资金费率套利系统

一个完整的加密货币资金费率套利分析和回测系统。

**最後更新日期：2025-06-22**

## 🔒 核心業務邏輯程式保護清單

> **重要提醒**：以下12個程式是核心業務邏輯相關的程式，已經過完整測試驗證。如非必要請勿修改，如需修改請先經過確認。

### 1. 📊 **market_cap_trading_pair.py**
- **用途**：市值交易對管理和篩選
- **目的**：根據市值條件篩選適合的交易對
- **功能**：
  - 獲取交易對的市值數據
  - 按市值排序和篩選
  - 提供市值基準的交易對列表
- **程式邏輯**：連接市值數據源 → 獲取交易對市值 → 排序篩選 → 輸出符合條件的交易對

### 2. 🔄 **exchange_trading_pair_v9.py**
- **用途**：交易所交易對數據處理（第9版優化版本）
- **目的**：統一處理多個交易所的交易對數據
- **功能**：
  - 多交易所交易對數據同步
  - 交易對格式標準化
  - 交易對可用性檢查
  - 支援的交易所整合
- **程式邏輯**：連接多交易所API → 獲取交易對列表 → 格式標準化 → 可用性驗證 → 統一數據輸出

### 3. 📈 **fetch_FR_history_group_v2.py**
- **用途**：批量獲取資金費率歷史數據（第2版群組優化）
- **目的**：高效率批量獲取多個交易對的資金費率歷史
- **功能**：
  - 批量API請求優化
  - 資金費率歷史數據獲取
  - 數據完整性檢查
  - 錯誤處理和重試機制
- **程式邏輯**：交易對分組 → 批量API請求 → 數據驗證 → 錯誤重試 → 數據庫存儲

### 4. 🧮 **calculate_FR_diff_v3.py**
- **用途**：計算資金費率差異（第3版優化算法）
- **目的**：計算不同交易所間的資金費率差異
- **功能**：
  - 跨交易所資金費率比較
  - 套利機會識別
  - 差異統計分析
  - 歷史趨勢分析
- **程式邏輯**：讀取多交易所數據 → 時間對齊 → 差異計算 → 統計分析 → 套利機會標記

### 5. 💰 **calculate_FR_return_list_v2.py**
- **用途**：計算資金費率收益列表（第2版優化版本）
- **目的**：計算各交易對的資金費率收益指標
- **功能**：
  - 多時間週期收益計算（1d, 2d, 7d, 14d, 30d, all）
  - ROI指標計算
  - 收益統計分析
  - 績效指標生成
- **程式邏輯**：讀取資金費率數據 → 多週期收益計算 → ROI統計 → 績效分析 → 數據庫更新

### 6. 🏆 **strategy_ranking_v2.py**
- **用途**：策略排名系統（第2版高性能版本）
- **目的**：基於多種策略對交易對進行排名
- **功能**：
  - 多策略排名計算
  - 批量處理優化
  - 實驗性策略支援
  - 排名結果數據庫存儲
- **程式邏輯**：載入收益數據 → 批量策略計算 → 排名生成 → 結果驗證 → 數據庫更新

### 7. 📊 **backtest_v3.py**
- **用途**：資金費率套利回測系統（第3版）
- **目的**：基於策略排名進行歷史回測驗證
- **功能**：
  - 策略排名回測
  - 進出場邏輯模擬
  - 資金費率收益計算
  - 績效指標統計
  - 持倉詳情記錄（position_detail）
- **程式邏輯**：讀取策略排名 → 模擬交易決策 → 計算收益 → 記錄持倉詳情 → 績效分析 → 結果報告

### 8. ⚙️ **ranking_config.py**
- **用途**：排名策略配置文件
- **目的**：定義各種排名策略的參數和邏輯
- **功能**：
  - 主要策略配置（original, momentum_focused, stability_focused等）
  - 實驗性策略配置（test_simple_1d, test_simple_avg等）
  - 策略參數設定
  - 組件權重配置
- **程式邏輯**：策略定義 → 參數配置 → 組件設定 → 權重分配

### 9. 🔧 **ranking_engine.py**
- **用途**：排名計算引擎
- **目的**：執行具體的排名計算邏輯
- **功能**：
  - 組件分數計算
  - 標準化處理
  - 加權組合
  - 最終排名生成
- **程式邏輯**：讀取策略配置 → 計算組件分數 → 標準化處理 → 加權組合 → 排名輸出

### 10. 📈 **draw_return_metrics.py**
- **用途**：收益指標視覺化
- **目的**：生成收益指標的圖表和視覺化報告
- **功能**：
  - 收益趨勢圖表
  - 績效比較圖
  - 統計分析圖表
  - 報告生成
- **程式邏輯**：讀取收益數據 → 數據處理 → 圖表生成 → 視覺化輸出

### 11. 🗄️ **database_operations.py**
- **用途**：數據庫操作核心模組
- **目的**：提供統一的數據庫操作接口
- **功能**：
  - 數據庫連接管理
  - CRUD操作封裝
  - 批量操作優化
  - 事務處理
- **程式邏輯**：連接管理 → 操作封裝 → 批量優化 → 錯誤處理

### 12. 🏗️ **database_schema.py**
- **用途**：數據庫結構定義
- **目的**：定義和管理數據庫表結構
- **功能**：
  - 表結構定義
  - 索引設計
  - 約束條件
  - 遷移管理
- **程式邏輯**：結構定義 → 創建語句 → 索引優化 → 約束設定

## 🚀 主要功能

### 核心工作流程
1. **數據獲取階段**：
   - `market_cap_trading_pair` → 篩選交易對
   - `exchange_trading_pair_v9` → 同步交易所數據
   - `fetch_FR_history_group_v2` → 批量獲取資金費率歷史

2. **數據處理階段**：
   - `calculate_FR_diff_v3` → 計算費率差異
   - `calculate_FR_return_list_v2` → 計算收益指標

3. **策略分析階段**：
   - `ranking_config` + `ranking_engine` → 策略配置和計算
   - `strategy_ranking_v2` → 生成策略排名

4. **回測驗證階段**：
   - `backtest_v3` → 歷史回測驗證

5. **結果展示階段**：
   - `draw_return_metrics` → 視覺化報告

### 數據管理
- `database_schema` → 數據庫結構管理
- `database_operations` → 數據庫操作接口

## 📋 系統特色

- **高性能批量處理**：V2版本程式都經過性能優化
- **模組化設計**：各程式職責分離，便於維護
- **完整測試覆蓋**：所有核心程式都經過詳細測試
- **靈活策略配置**：支援多種排名策略和實驗性策略
- **穩定數據管理**：統一的數據庫操作和結構管理

## ⚠️ 重要提醒

**核心程式保護**：上述12個核心業務邏輯程式已經過完整測試驗證，如非必要請勿修改。如需修改請先確認，以確保系統穩定性。

**更新記錄**：
- 2025-06-22：完成核心程式測試驗證，建立保護清單
