# Backtest_v2.py 手動測試執行指南

## 📋 測試概覽

**測試目標**：驗證資金費率套利回測系統的完整功能
**測試期間**：2024-06-01 至 2024-06-05 (5天)
**測試策略**：original
**核心參數**：
- 初始資金：$10,000
- 持倉比例：25% ($2,500/次)
- 最大持倉：3個
- 進場條件：前3名
- 離場條件：跌出前20名

---

## 🗂️ 測試文件說明

1. **`test_data_backtest_v2.sql`** - 測試數據（執行前先載入）
2. **`test_backtest_v2_verification.sql`** - 驗證查詢（執行後驗證結果）
3. **`test_backtest_v2_execution_guide.md`** - 本執行指南

---

## 📝 測試步驟

### **步驟1：準備測試環境**

1. **載入測試數據**
   ```bash
   # 在DB Browser中執行
   # 打開 data/funding_rate.db
   # 執行 test_data_backtest_v2.sql 中的所有SQL
   ```

2. **驗證數據載入成功**
   ```sql
   -- 檢查測試數據
   SELECT COUNT(*) FROM return_metrics WHERE trading_pair LIKE 'BT_TEST%';
   -- 預期結果：28條記錄 (6個交易對 × 5天 - 2條 = 28條)
   
   SELECT COUNT(*) FROM strategy_ranking WHERE trading_pair LIKE 'BT_TEST%';
   -- 預期結果：29條記錄 (5天的排名數據)
   ```

### **步驟2：執行回測程序**

1. **啟動回測系統**
   ```bash
   cd /Users/waynechen/Downloads/Arbitrage01-3
   python backtest_v2.py
   ```

2. **選擇測試策略**
   - 選擇策略：`1. original`
   - 系統會自動偵測可用期間

3. **確認回測參數**
   ```
   策略參數:
   - 初始資金: $10,000
   - 每次進場資金比例: 25.0%
   - 手續費率: 0.1000%
   - 每次離場資金比例: 100.0%
   - 最大持倉數: 5
   - 進場條件: 綜合評分前5名
   - 離場條件: 排名跌出前20名
   - 回測期間: 2024-06-01 至 2024-06-05
   ```

4. **觀察執行過程**
   - 注意進場/離場事件
   - 檢查資金費率收益計算
   - 確認持倉數量限制

### **步驟3：基本結果檢查**

執行完成後，程序應該顯示：
- 回測完成信息
- 績效摘要報告
- 圖表生成信息
- 數據庫保存確認

**預期輸出示例**：
```
🚀 開始策略回測: original
📅 回測期間: 2024-06-01 至 2024-06-05
🔍 回測ID: original_2024-06-01_2024-06-05_20241223_143022

處理第 1/5 個回測日: 2024-06-01
第一個回測日，只記錄初始狀態，不進行交易

處理第 2/5 個回測日: 2024-06-02
使用 2024-06-01 的策略檔案進行 2024-06-02 的交易
進場: BT_TEST1/USDT_binance_bybit
進場: BT_TEST2/USDT_binance_okx
進場: BT_TEST3/USDT_bybit_okx
  總餘額: 10000.00, 持倉數: 3

回測完成!
📊 正在生成回測報告並保存到數據庫...
```

### **步驟4：詳細結果驗證**

在DB Browser中執行 `test_backtest_v2_verification.sql` 的各個驗證區塊：

#### **驗證區塊1：回測基本信息檢查**
**預期結果**：
- 找到一條回測記錄
- strategy_name = 'original'
- start_date = '2024-06-01'
- end_date = '2024-06-05'
- initial_capital = 10000
- total_days = 5

#### **驗證區塊2：交易事件序列檢查**
**預期事件序列**：
1. **2024-06-02**: 3次進場事件 (TEST1, TEST2, TEST3)
2. **2024-06-03**: 3次資金費率事件 + 可能的進出場
3. **2024-06-04**: 資金費率事件 + 排名變化導致的交易
4. **2024-06-05**: 資金費率事件 + 可能的離場

#### **驗證區塊3：進場邏輯驗證**
**預期結果**：
- BT_TEST1 (排名1) ✅ 已進場
- BT_TEST2 (排名2) ✅ 已進場  
- BT_TEST3 (排名3) ✅ 已進場
- BT_TEST4 (排名4) ✅ 正確未進場
- BT_TEST5 (排名5) ✅ 正確未進場

#### **驗證區塊4：持倉限制驗證**
**預期結果**：
- 每天的active_positions ≤ 3
- limit_check = '✅ 未超過限制'

#### **驗證區塊5：資金費率PnL計算驗證**
**預期計算邏輯**：
- 每個持倉 = $2,500 (25% × $10,000)
- 有效金額 = $1,250 (套利只用一半)
- PnL = $1,250 × roi_1d / 100

**手工驗證示例**：
- BT_TEST1 在2024-06-03: roi_1d = 0.365%
- 預期PnL = $1,250 × 0.365 / 100 = $4.56
- 系統PnL應該 ≈ $4.56

#### **驗證區塊6：排名變化交易驗證**
**2024-06-02排名變化分析**：
- BT_TEST1: 排名1→5 (下降4) → 應該離場
- BT_TEST4: 排名4→1 (上升3) → 應該進場
- BT_TEST2: 排名2→2 (不變) → 繼續持有
- BT_TEST3: 排名3→3 (不變) → 繼續持有

#### **驗證區塊7：負收益處理驗證**
**2024-06-03負收益檢查**：
- BT_TEST1: roi_1d = -0.73% → PnL應為負數
- BT_TEST2: roi_1d = -0.55% → PnL應為負數
- 其他正收益交易對 → PnL應為正數

#### **驗證區塊8：最終績效指標驗證**
**預期指標合理性**：
- total_days = 5
- profit_days + loss_days + break_even_days = 5
- win_rate = profit_days / total_days
- max_drawdown ≥ 0

#### **驗證區塊9：資金平衡驗證**
**預期結果**：
- 每天的balance_check = '✅ 資金平衡'
- cash_balance + position_balance = calculated_total

#### **驗證區塊10：完整性檢查摘要**
**預期統計**：
- trading_days = 4 (實際交易天數，第一天不交易)
- entry_events ≥ 3 (至少初始進場)
- exit_events ≥ 0 (可能有離場)
- funding_events ≥ 12 (每天每個持倉的資金費率)
- unique_pairs_traded ≤ 6 (最多6個測試交易對)

---

## 🎯 測試場景驗證重點

### **場景1：基本進場測試 (2024-06-01→2024-06-02)**
- ✅ 驗證前3名正確進場
- ✅ 驗證持倉金額計算 ($2,500/個)
- ✅ 驗證最大持倉限制 (3個)

### **場景2：排名變化測試 (2024-06-02)**
- ✅ 驗證BT_TEST4從排名4躍升到排名1，觸發進場
- ✅ 驗證BT_TEST1從排名1下降到排名5，觸發離場
- ✅ 驗證持倉調整邏輯

### **場景3：負收益測試 (2024-06-03)**
- ✅ 驗證負收益正確計算為負PnL
- ✅ 驗證資金費率計算邏輯不受正負影響

### **場景4：持倉限制測試 (2024-06-04)**
- ✅ 驗證即使有6個高排名交易對，也不會超過3個持倉
- ✅ 驗證進場優先級邏輯

### **場景5：完整週期測試 (2024-06-05)**
- ✅ 驗證排名下滑觸發離場
- ✅ 驗證完整的進場→持有→離場週期

---

## ⚠️ 常見問題排查

### **問題1：沒有找到策略數據**
**解決方案**：
1. 確認測試數據已正確載入
2. 檢查日期範圍是否正確
3. 確認strategy_name = 'original'

### **問題2：PnL計算不匹配**
**檢查項目**：
1. 持倉金額是否為$2,500
2. 有效金額是否為$1,250 (除以2)
3. roi_1d是否使用正確的百分比格式

### **問題3：持倉數量異常**
**檢查項目**：
1. 確認MAX_POSITIONS參數設定
2. 檢查進場邏輯是否正確執行
3. 驗證離場條件是否正確觸發

### **問題4：資金不平衡**
**檢查項目**：
1. 檢查進場/離場金額計算
2. 驗證資金費率PnL計算
3. 確認手續費扣除邏輯

---

## 📊 成功標準

### **功能正確性**
- ✅ 進場邏輯：前3名正確進場
- ✅ 離場邏輯：排名變化正確觸發離場
- ✅ 持倉限制：不超過最大持倉數
- ✅ PnL計算：資金費率收益計算正確

### **數據完整性**
- ✅ 所有交易事件正確記錄
- ✅ 資金平衡始終正確
- ✅ 績效指標計算準確
- ✅ 數據庫保存完整

### **業務邏輯**
- ✅ 策略排名正確影響交易決策
- ✅ 負收益情況正確處理
- ✅ 時間序列邏輯正確（使用前一天排名）
- ✅ 風險控制機制有效

---

## 🚀 測試完成檢查清單

- [ ] 測試數據成功載入
- [ ] 回測程序正常執行完成
- [ ] 10個驗證區塊全部通過
- [ ] 5個測試場景邏輯正確
- [ ] 績效指標計算準確
- [ ] 數據庫記錄完整
- [ ] 圖表文件正常生成
- [ ] 無異常錯誤或警告

**測試通過標準**：所有檢查項目都標記為 ✅，表示回測系統功能完全正確。 